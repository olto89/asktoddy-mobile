name: TestFlight Deployment

on:
  push:
    branches: [main, staging]
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  deploy-testflight:
    name: Build and Deploy to TestFlight
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🚀 Build iOS app for TestFlight
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            eas build --platform ios --profile production --non-interactive --wait
          else
            eas build --platform ios --profile staging --non-interactive --wait
          fi

      - name: 🚀 Submit to TestFlight
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            eas submit --platform ios --profile production --non-interactive
          else
            eas submit --platform ios --profile staging --non-interactive
          fi

      - name: 💬 Notify on Success
        if: success()
        run: |
          echo "🎉 Successfully deployed to TestFlight!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: 💬 Notify on Failure
        if: failure()
        run: |
          echo "❌ TestFlight deployment failed"
          echo "Check the logs above for details"